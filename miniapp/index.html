4️⃣ MiniApp (miniapp/index.html) с разграничением ролей и добавлением пользователей
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Pilot Flights</title>
<style>
body { font-family: Arial; padding:20px; }
table { border-collapse: collapse; width: 100%; margin-top:10px;}
th,td{border:1px solid #ccc;padding:8px;text-align:left;}
th{background:#f2f2f2;}
button{padding:5px 10px;margin:2px;}
#modal,#userModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);}
#modalContent,#userContent{background:white;margin:100px auto;padding:20px;width:400px;border-radius:8px;}
</style>
</head>
<body>

<h1>Таблица полётов</h1>

<label>Ваша роль: </label>
<select id="roleFilter">
  <option value="pilot">Пилот</option>
  <option value="manager">Менеджер</option>
  <option value="accountant">Бухгалтер</option>
  <option value="admin">Админ</option>
</select>

<button id="addBtn">Добавить полёт</button>
<button id="addUserBtn">Добавить пользователя</button>

<table id="flights">
  <thead><tr id="tableHeader"></tr></thead>
  <tbody></tbody>
</table>

<!-- Модальное окно для полета -->
<div id="modal">
  <div id="modalContent">
    <h3 id="modalTitle">Добавить полёт</h3>
    <div id="modalBody"></div>
    <button onclick="saveFlight()">Сохранить</button>
    <button onclick="closeModal()">Отмена</button>
  </div>
</div>

<!-- Модальное окно для пользователя -->
<div id="userModal">
  <div id="userContent">
    <h3>Добавить пользователя</h3>
    <label>TG ID: <input type="text" id="tg_id"></label><br><br>
    <label>Username: <input type="text" id="username"></label><br><br>
    <label>Role:
      <select id="role">
        <option value="pilot">Пилот</option>
        <option value="manager">Менеджер</option>
        <option value="accountant">Бухгалтер</option>
        <option value="admin">Админ</option>
      </select>
    </label><br><br>
    <button onclick="saveUser()">Сохранить</button>
    <button onclick="closeUserModal()">Отмена</button>
  </div>
</div>

<script>
let flights=[];
let editingId=null;
let currentRole="pilot";

document.getElementById("roleFilter").addEventListener("change", e=>{
  currentRole=e.target.value;
  renderFlights();
});

document.getElementById("addBtn").addEventListener("click",()=>openModal());
document.getElementById("addUserBtn").addEventListener("click",()=>openUserModal());

async function loadFlights(){
  const res = await fetch("/api/flights");
  flights = await res.json();
  renderFlights();
}

function renderFlights(){
  const tbody=document.querySelector("#flights tbody");
  const header=document.getElementById("tableHeader");
  tbody.innerHTML=""; header.innerHTML="";
  const columns=[];
  if(currentRole==="pilot") columns.push("Date","Route","Status","Pilot Comment","Actions");
  if(currentRole==="manager") columns.push("Date","Route","Status","Income","Expense","Pilot Comment","Manager Comment","Actions");
  if(currentRole==="accountant") columns.push("Date","Route","Status","Income","Expense");
  if(currentRole==="admin") columns.push("Date","Route","Status","Income","Expense","Pilot Comment","Manager Comment","Actions");
  columns.forEach(c=>{const th=document.createElement("th"); th.textContent=c; header.appendChild(th);});
  flights.forEach(f=>{
    const tr=document.createElement("tr");
    if(currentRole==="pilot"){
      tr.innerHTML=`<td>${f.date||""}</td><td>${f.route||""}</td><td>${f.status||""}</td><td>${f.pilot_comment||""}</td><td><button onclick="editFlight('${f.id}')">Отметить</button></td>`;
    }
    if(currentRole==="manager"){
      tr.innerHTML=`<td>${f.date||""}</td><td>${f.route||""}</td><td>${f.status||""}</td><td>${f.income||""}</td><td>${f.expense||""}</td><td>${f.pilot_comment||""}</td><td>${f.manager_comment||""}</td><td><button onclick="editFlight('${f.id}')">Редактировать</button></td>`;
    }
    if(currentRole==="accountant"){
      tr.innerHTML=`<td>${f.date||""}</td><td>${f.route||""}</td><td>${f.status||""}</td><td>${f.income||""}</td><td>${f.expense||""}</td>`;
    }
    if(currentRole==="admin"){
      tr.innerHTML=`<td>${f.date||""}</td><td>${f.route||""}</td><td>${f.status||""}</td><td>${f.income||""}</td><td>${f.expense||""}</td><td>${f.pilot_comment||""}</td><td>${f.manager_comment||""}</td><td><button onclick="editFlight('${f.id}')">Редактировать</button></td>`;
    }
    tbody.appendChild(tr);
  });
}

function openModal(){ editingId=null; document.getElementById("modalTitle").textContent="Добавить полёт"; buildModalFields({}); document.getElementById("modal").style.display="block"; }
function closeModal(){ document.getElementById("modal").style.display="none"; }

function editFlight(id){
  editingId=id;
  const f=flights.find(f=>f.id===id);
  document.getElementById("modalTitle").textContent=currentRole==="pilot"?"Отметить полёт":"Редактировать полёт";
  buildModalFields(f);
  document.getElementById("modal").style.display="block";
}

function buildModalFields(f){
  const body=document.getElementById("modalBody"); body.innerHTML="";
  if(["manager","admin"].includes(currentRole)){
    body.innerHTML=`<label>Date: <input type="date" id="date" value="${f.date||''}"></label><br><br>
      <label>Route: <input type="text" id="route" value="${f.route||''}"></label><br><br>
      <label>Status: <input type="text" id="status" value="${f.status||''}"></label><br><br>
      <label>Income: <input type="number" id="income" value="${f.income||''}"></label><br><br>
      <label>Expense: <input type="number" id="expense" value="${f.expense||''}"></label><br><br>
      <label>Pilot Comment: <input type="text" id="pilot_comment" value="${f.pilot_comment||''}"></label><br><br>
      <label>Manager Comment: <input type="text" id="manager_comment" value="${f.manager_comment||''}"></label><br><br>`;
  } else if(currentRole==="pilot"){
    body.innerHTML=`<p>Дата: ${f.date||''}</p><p>Маршрут: ${f.route||''}</p><p>Статус: ${f.status||''}</p>
      <label>Ваш комментарий: <input type="text" id="pilot_comment" value="${f.pilot_comment||''}"></label><br><br>`;
  } else if(currentRole==="accountant"){
    body.innerHTML=`<label>Income: <input type="number" id="income" value="${f.income||''}"></label><br><br>
      <label>Expense: <input type="number" id="expense" value="${f.expense||''}"></label><br><br>`;
  }
}

async function saveFlight(){
  const flight={};
  if(["manager","admin"].includes(currentRole)){
    flight.date=document.getElementById("date").value;
    flight.route=document.getElementById("route").value;
    flight.status=document.getElementById("status").value;
    flight.income=document.getElementById("income").value;
    flight.expense=document.getElementById("expense").value;
    flight.pilot_comment=document.getElementById("pilot_comment").value;
    flight.manager_comment=document.getElementById("manager_comment").value;
  } else if(currentRole==="pilot"){
    flight.pilot_comment=document.getElementById("pilot_comment").value;
  } else if(currentRole==="accountant"){
    flight.income=document.getElementById("income").value;
    flight.expense=document.getElementById("expense").value;
  }
  if(editingId){
    flight.id=editingId;
    await fetch("/api/flights",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(flight)});
  } else if(!["pilot","accountant"].includes(currentRole)){
    await fetch("/api/flights",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(flight)});
  }
  closeModal();
  await loadFlights();
}

// Пользователи
function openUserModal(){ document.getElementById("userModal").style.display="block"; }
function closeUserModal(){ document.getElementById("userModal").style.display="none"; }

async function saveUser(){
  const tg_id=document.getElementById("tg_id").value;
  const username=document.getElementById("username").value;
  const role=document.getElementById("role").value;
  if(!tg_id || !username) return alert("Заполните все поля");
  await fetch("/api/users",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tg_id,username,role})});
  closeUserModal();
  alert("Пользователь добавлен");
}

loadFlights();
</script>

</body>
</html>